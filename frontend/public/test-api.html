<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Insert/Fetch API</title>
    <style>
        body { font-family: Arial; padding: 20px; max-width: 800px; margin: 0 auto; }
        .section { background: #f5f5f5; padding: 15px; margin: 10px 0; border-radius: 8px; }
        button { background: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #45a049; }
        .result { background: white; padding: 10px; margin: 10px 0; border-radius: 5px; white-space: pre-wrap; }
        .success { border-left: 4px solid #4CAF50; }
        .error { border-left: 4px solid #f44336; }
        input { width: 300px; padding: 8px; margin: 5px; border: 1px solid #ddd; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>üß™ Test Insert/Fetch API</h1>
    
    <div class="section">
        <h2>Step 1: Login & Get Token</h2>
        <input type="email" id="email" placeholder="Your email" value="">
        <input type="password" id="password" placeholder="Your password" value="">
        <button onclick="login()">Login</button>
        <div id="tokenResult" class="result" style="display:none;"></div>
    </div>

    <div class="section">
        <h2>Step 2: Test INSERT</h2>
        <input type="text" id="foodName" placeholder="Food name" value="Test Food Browser">
        <input type="number" id="calories" placeholder="Calories" value="150">
        <input type="number" id="protein" placeholder="Protein (g)" value="10">
        <input type="number" id="carbs" placeholder="Carbs (g)" value="20">
        <button onclick="testInsert()">Test INSERT</button>
        <div id="insertResult" class="result" style="display:none;"></div>
    </div>

    <div class="section">
        <h2>Step 3: Test FETCH</h2>
        <input type="text" id="searchQuery" placeholder="Search term" value="Test">
        <button onclick="testFetch()">Test FETCH</button>
        <div id="fetchResult" class="result" style="display:none;"></div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:3031/api'; // Change to your backend URL
        let authToken = localStorage.getItem('token') || '';

        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const resultDiv = document.getElementById('tokenResult');
            
            try {
                const response = await fetch(`${API_BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                const data = await response.json();
                if (data.token) {
                    authToken = data.token;
                    localStorage.setItem('token', authToken);
                    resultDiv.className = 'result success';
                    resultDiv.style.display = 'block';
                    resultDiv.textContent = `‚úÖ Login Success!\nToken saved: ${authToken.substring(0, 20)}...`;
                } else {
                    throw new Error('No token received');
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.style.display = 'block';
                resultDiv.textContent = `‚ùå Login Failed: ${error.message}`;
            }
        }

        async function testInsert() {
            if (!authToken) {
                alert('Please login first!');
                return;
            }

            const foodName = document.getElementById('foodName').value;
            const calories = parseFloat(document.getElementById('calories').value) || 0;
            const protein = parseFloat(document.getElementById('protein').value) || null;
            const carbs = parseFloat(document.getElementById('carbs').value) || null;

            const resultDiv = document.getElementById('insertResult');
            resultDiv.style.display = 'block';

            try {
                const response = await fetch(`${API_BASE_URL}/data`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        food_name: foodName,
                        calories: calories,
                        protein_g: protein,
                        carbs_g: carbs,
                        data_source: 'AI Generated (Browser Test)'
                    })
                });

                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `‚úÖ INSERT SUCCESS (${response.status})\n${JSON.stringify(data, null, 2)}`;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `‚ùå INSERT FAILED (${response.status})\n${JSON.stringify(data, null, 2)}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå INSERT ERROR: ${error.message}`;
            }
        }

        async function testFetch() {
            if (!authToken) {
                alert('Please login first!');
                return;
            }

            const searchQuery = document.getElementById('searchQuery').value;
            const resultDiv = document.getElementById('fetchResult');
            resultDiv.style.display = 'block';

            try {
                const url = `${API_BASE_URL}/data${searchQuery ? '?search=' + encodeURIComponent(searchQuery) : ''}`;
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `‚úÖ FETCH SUCCESS (${response.status})\nFound: ${data.count || 0} results\n\n${JSON.stringify(data, null, 2)}`;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `‚ùå FETCH FAILED (${response.status})\n${JSON.stringify(data, null, 2)}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå FETCH ERROR: ${error.message}`;
            }
        }

        // Auto-load token if available
        if (authToken) {
            document.getElementById('tokenResult').textContent = `Token loaded from localStorage: ${authToken.substring(0, 20)}...`;
            document.getElementById('tokenResult').className = 'result success';
            document.getElementById('tokenResult').style.display = 'block';
        }
    </script>
</body>
</html>

